# 🎯 מדריך הנחות, קופונים, גיפט קארד וקרדיט

## 📋 סקירה כללית

מערכת התשלומים וההנחות כוללת 4 סוגים שונים של מנגנונים, כל אחד עם מטרה שונה:

1. **הנחות אוטומטיות** - חלות אוטומטית ללא קוד
2. **קופונים** - דורשים קוד קופון
3. **גיפט קארד** - כרטיס מתנה שניתן להשתמש בו בנוסף לקופון
4. **קרדיט בחנות** - יתרה של לקוח שניתן להשתמש בה בתשלום

---

## 🎫 1. הנחות אוטומטיות (Automatic Discounts)

### מה זה?
הנחות שמוחלות **אוטומטית** ללא צורך בקוד קופון. המערכת בודקת את התנאים ומחילה את ההנחה אוטומטית.

### תכונות:
- ✅ **מוחלות אוטומטית** - ללא צורך בקוד
- ✅ **עדיפות גבוהה** - מחושבות קודם לקופונים
- ✅ **תמיכה בכל התנאים** - סכום, כמות, לקוח, זמן, מוצרים, קטגוריות, תגיות
- ✅ **שילובים** - אפשרות למנוע או לאפשר שילוב עם קופונים

### דוגמאות:
- "10% הנחה על כל המוצרים" - חלה אוטומטית על כל הזמנה
- "20% הנחה ל-VIP על הזמנות מעל ₪500" - חלה רק ללקוחות VIP עם הזמנה מעל ₪500
- "משלוח חינם על הזמנות מעל ₪200" - חלה אוטומטית

### איך זה עובד?
1. הלקוח מוסיף מוצרים לעגלה
2. המערכת בודקת את כל ההנחות האוטומטיות הפעילות
3. המערכת בודקת את התנאים (סכום, כמות, לקוח, זמן, וכו')
4. אם התנאים מתקיימים - ההנחה מוחלת אוטומטית
5. ההנחה מוצגת בעגלה ובצ'ק אאוט

### מיקום במערכת:
- **טבלה במסד נתונים:** `automatic_discounts`
- **API:** `/api/automatic-discounts`
- **Dashboard:** `/automatic-discounts` (עדיין לא קיים)
- **מנוע חישוב:** `CartCalculator` - מחשב אוטומטית

---

## 🎟️ 2. קופונים (Discount Codes / Coupons)

### מה זה?
הנחות שדורשות **קוד קופון**. הלקוח צריך להזין את הקוד כדי לקבל את ההנחה.

### תכונות:
- ✅ **דורש קוד קופון** - הלקוח צריך להזין את הקוד
- ✅ **עדיפות נמוכה יותר** - מחושבים אחרי הנחות אוטומטיות
- ✅ **מעקב שימוש** - `usage_count` ו-`usage_limit`
- ✅ **תוקף תאריכים** - `starts_at` ו-`ends_at`
- ✅ **שילובים** - אפשרות למנוע או לאפשר שילוב עם הנחות אוטומטיות

### דוגמאות:
- קוד "SUMMER20" - 20% הנחה על כל המוצרים
- קוד "FREESHIP" - משלוח חינם
- קוד "50OFF" - ₪50 הנחה על הזמנות מעל ₪300

### איך זה עובד?
1. הלקוח מוסיף מוצרים לעגלה
2. הלקוח מזין קוד קופון בשדה הקופון
3. המערכת בודקת את הקוד:
   - האם הקוד קיים?
   - האם הקוד פעיל?
   - האם הקוד בתוקף?
   - האם הקוד לא הגיע למגבלת שימוש?
   - האם סכום ההזמנה עומד בתנאים?
4. אם הכל תקין - הקופון מוחל
5. הקופון מוצג בעגלה ובצ'ק אאוט

### מיקום במערכת:
- **טבלה במסד נתונים:** `discount_codes`
- **API:** `/api/discounts`
- **Dashboard:** `/discounts` ✅ (קיים)
- **Storefront:** שדה קופון בעגלה ובצ'ק אאוט ✅ (קיים)
- **מנוע חישוב:** `CartCalculator` - מחשב את הקופון

---

## 🎁 3. גיפט קארד (Gift Cards)

### מה זה?
כרטיס מתנה עם קוד ייחודי וערך כספי. ניתן להשתמש בו **בנוסף לקופון** (או במקום קופון).

### תכונות:
- ✅ **קוד ייחודי** - כל כרטיס מתנה יש לו קוד ייחודי
- ✅ **ערך כספי** - `initial_value` ו-`current_value`
- ✅ **תאריך תפוגה** - `expires_at` (אופציונלי)
- ✅ **שימוש חלקי** - ניתן להשתמש בחלק מהערך
- ✅ **שילוב עם קופון** - ניתן להשתמש בגיפט קארד **בנוסף** לקופון
- ✅ **מעקב תנועות** - `gift_card_transactions` - מעקב אחר כל שימוש

### דוגמאות:
- כרטיס מתנה של ₪200 שניתן להשתמש בו בכל הזמנה
- כרטיס מתנה של ₪500 שניתן להשתמש בו בנוסף לקופון "SUMMER20"
- כרטיס מתנה עם תאריך תפוגה - תפוגה בעוד שנה

### איך זה אמור לעבוד?
1. הלקוח מוסיף מוצרים לעגלה
2. הלקוח מזין קוד קופון (אופציונלי)
3. הלקוח מזין קוד כרטיס מתנה
4. המערכת בודקת את כרטיס המתנה:
   - האם הקוד קיים?
   - האם הכרטיס פעיל?
   - האם הכרטיס לא פג תוקף?
   - מה היתרה הנוכחית?
5. אם הכל תקין - כרטיס המתנה מוחל
6. כרטיס המתנה מוצג כאמצעי תשלום בצ'ק אאוט
7. אם היתרה לא מכסה את כל הסכום - הלקוח צריך לשלם את ההפרש

### מיקום במערכת:
- **טבלה במסד נתונים:** `gift_cards`, `gift_card_transactions` ✅ (קיים)
- **API:** `/api/gift-cards` ❌ (לא קיים)
- **Dashboard:** `/gift-cards` ⚠️ (קיים אבל לא פונקציונלי - אין API)
- **Storefront:** ❌ (לא קיים - צריך להוסיף שדה כרטיס מתנה בצ'ק אאוט)
- **מנוע חישוב:** ❌ (לא קיים - צריך להוסיף תמיכה ב-`CartCalculator`)

### מה חסר?
- [ ] API endpoints ל-gift cards
- [ ] שדה כרטיס מתנה בצ'ק אאוט
- [ ] אינטגרציה במנוע החישוב (`CartCalculator`)
- [ ] תמיכה בשילוב עם קופון
- [ ] תמיכה בשימוש חלקי (אם היתרה לא מכסה את כל הסכום)
- [ ] איזור אישי ללקוח להצגת כרטיסי מתנה שלו

---

## 💳 4. קרדיט בחנות (Store Credits)

### מה זה?
יתרה כספית של לקוח שניתן להשתמש בה בתשלום. זהו **אמצעי תשלום** שנראה כמו כרטיס אשראי או העברה בנקאית.

### תכונות:
- ✅ **יתרה כספית** - `balance` - יתרה של הלקוח
- ✅ **מעקב תנועות** - `store_credit_transactions` - מעקב אחר כל תנועה
- ✅ **תאריך תפוגה** - `expires_at` (אופציונלי)
- ✅ **אמצעי תשלום** - מופיע כאמצעי תשלום בצ'ק אאוט
- ✅ **שילוב עם קופון וגיפט קארד** - ניתן להשתמש בקרדיט בנוסף לקופון וגיפט קארד
- ✅ **צבירה** - לקוח יכול לצבור קרדיט מהזמנות, החזרות, וכו'

### דוגמאות:
- לקוח עם יתרה של ₪150 יכול להשתמש בה בתשלום
- לקוח יכול לצבור קרדיט מהזמנות קודמות
- לקוח יכול לקבל קרדיט כפיצוי על החזרה

### איך זה אמור לעבוד?
1. הלקוח מחובר לחשבון (איזור אישי)
2. הלקוח מוסיף מוצרים לעגלה
3. הלקוח מזין קוד קופון (אופציונלי)
4. הלקוח מזין קוד כרטיס מתנה (אופציונלי)
5. בצ'ק אאוט, הלקוח רואה את היתרה שלו
6. הלקוח בוחר להשתמש בקרדיט כאמצעי תשלום
7. אם היתרה מכסה את כל הסכום - ההזמנה מתבצעת ללא תשלום נוסף
8. אם היתרה לא מכסה את כל הסכום - הלקוח צריך לשלם את ההפרש

### מיקום במערכת:
- **טבלה במסד נתונים:** `store_credits`, `store_credit_transactions` ✅ (קיים)
- **API:** `/api/store-credits` ❌ (לא קיים)
- **Dashboard:** `/store-credits` ⚠️ (קיים אבל לא פונקציונלי - אין API)
- **Storefront:** ❌ (לא קיים - צריך להוסיף כאמצעי תשלום בצ'ק אאוט)
- **איזור אישי:** ❌ (לא קיים בכלל - צריך ליצור)
- **מנוע חישוב:** ❌ (לא קיים - צריך להוסיף תמיכה ב-`CartCalculator`)

### מה חסר?
- [ ] **איזור אישי ללקוח** - זה הכי חשוב! אין בכלל:
  - [ ] דף התחברות/הרשמה ללקוח
  - [ ] דף פרופיל לקוח
  - [ ] דף הזמנות שלי
  - [ ] דף קרדיט בחנות (יתרה ותנועות)
  - [ ] דף כרטיסי מתנה שלי
  - [ ] דף כתובות שלי
- [ ] API endpoints ל-store credits
- [ ] אמצעי תשלום "קרדיט בחנות" בצ'ק אאוט
- [ ] אינטגרציה במנוע החישוב (`CartCalculator`)
- [ ] תמיכה בשילוב עם קופון וגיפט קארד
- [ ] תמיכה בשימוש חלקי (אם היתרה לא מכסה את כל הסכום)
- [ ] מערכת צבירת קרדיט (מהזמנות, החזרות, וכו')

---

## 🔄 סדר עדיפויות ושילובים

### סדר החישוב:
1. **הנחות אוטומטיות** (לפי `priority`)
2. **קופונים** (אם ניתן לשלב)
3. **גיפט קארד** (אם הוזן)
4. **קרדיט בחנות** (אם הלקוח מחובר ובוחר להשתמש)

### כללי שילוב:
- ✅ **הנחה אוטומטית + קופון** - ניתן לשלב (אם `can_combine_with_codes = true`)
- ✅ **קופון + גיפט קארד** - ניתן לשלב (גיפט קארד הוא אמצעי תשלום)
- ✅ **קופון + גיפט קארד + קרדיט** - ניתן לשלב (כולם אמצעי תשלום/הנחה שונים)

---

## 📊 טבלה השוואתית

| תכונה | הנחות אוטומטיות | קופונים | גיפט קארד | קרדיט בחנות |
|------|-----------------|---------|-----------|-------------|
| **דורש קוד** | ❌ לא | ✅ כן | ✅ כן | ❌ לא (מחובר) |
| **מוחל אוטומטית** | ✅ כן | ❌ לא | ❌ לא | ❌ לא (בחירה) |
| **עדיפות** | גבוהה | נמוכה | תשלום | תשלום |
| **מעקב שימוש** | ❌ לא | ✅ כן | ✅ כן | ✅ כן |
| **תוקף תאריכים** | ✅ כן | ✅ כן | ✅ כן | ✅ כן |
| **שילוב עם קופון** | ✅ כן (אם `can_combine_with_codes = true`) | - | ✅ כן | ✅ כן |
| **אמצעי תשלום** | ❌ לא | ❌ לא | ✅ כן | ✅ כן |
| **שימוש חלקי** | ❌ לא רלוונטי | ❌ לא רלוונטי | ✅ כן | ✅ כן |
| **איזור אישי** | ❌ לא רלוונטי | ❌ לא רלוונטי | ⚠️ צריך | ⚠️ צריך |
| **סטטוס יישום** | ✅ מיושם | ✅ מיושם | ⚠️ חלקי | ❌ לא מיושם |

---

## ✅ מה מיושם כרגע?

### ✅ מיושם במלואו:
1. **הנחות אוטומטיות** - מיושם במלואו:
   - טבלה במסד נתונים ✅
   - מנוע חישוב ✅
   - API endpoints (צריך לבדוק) ⚠️
   - Dashboard (צריך לבדוק) ⚠️

2. **קופונים** - מיושם במלואו:
   - טבלה במסד נתונים ✅
   - מנוע חישוב ✅
   - API endpoints ✅
   - Dashboard ✅
   - Storefront (שדה קופון) ✅

### ⚠️ מיושם חלקית:
3. **גיפט קארד** - מיושם חלקית:
   - טבלה במסד נתונים ✅
   - Dashboard (דף קיים אבל לא פונקציונלי) ⚠️
   - API endpoints ❌
   - Storefront ❌
   - מנוע חישוב ❌

### ❌ לא מיושם:
4. **קרדיט בחנות** - לא מיושם:
   - טבלה במסד נתונים ✅
   - Dashboard (דף קיים אבל לא פונקציונלי) ⚠️
   - API endpoints ❌
   - Storefront ❌
   - מנוע חישוב ❌
   - **איזור אישי** ❌ (זה הכי חשוב!)

---

## 🎯 סדר עדיפויות לפיתוח

### עדיפות גבוהה (Critical):
1. **איזור אישי ללקוח** - זה הבסיס לכל השאר:
   - דף התחברות/הרשמה
   - דף פרופיל
   - דף הזמנות שלי
   - דף קרדיט בחנות
   - דף כרטיסי מתנה שלי

### עדיפות בינונית (Important):
2. **גיפט קארד - Storefront**:
   - שדה כרטיס מתנה בצ'ק אאוט
   - אינטגרציה במנוע החישוב
   - API endpoints

3. **קרדיט בחנות - Storefront**:
   - אמצעי תשלום "קרדיט בחנות" בצ'ק אאוט
   - אינטגרציה במנוע החישוב
   - API endpoints

### עדיפות נמוכה (Nice to have):
4. **הנחות אוטומטיות - Dashboard**:
   - דף ניהול הנחות אוטומטיות
   - יצירה/עריכה/מחיקה

5. **גיפט קארד - Dashboard**:
   - יצירת כרטיסי מתנה
   - ניהול כרטיסי מתנה

6. **קרדיט בחנות - Dashboard**:
   - הוספת קרדיט ללקוח
   - ניהול קרדיט

---

## 📝 הערות חשובות

1. **איזור אישי הוא הכרחי** - בלי זה, קרדיט בחנות לא יכול לעבוד (כי צריך להיות מחובר)
2. **גיפט קארד יכול לעבוד בלי איזור אישי** - אבל עדיף עם (כדי לראות את הכרטיסים שלי)
3. **קרדיט בחנות חייב איזור אישי** - כי צריך להיות מחובר כדי לראות את היתרה
4. **כל האמצעים יכולים לעבוד יחד** - הנחה אוטומטית + קופון + גיפט קארד + קרדיט

---

**עודכן:** {{ new Date().toISOString() }}

